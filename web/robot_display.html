<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>KENZA Robot Display</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #070710;
            --accent: #4fc3f7;
            --green: #4caf50;
            --orange: #ffaa00;
            --red: #f44336;
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.1);
            --dim: rgba(255, 255, 255, 0.45);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            color: #fff;
            user-select: none
        }

        /* TOP BAR */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 300;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(7, 7, 16, .98), transparent);
        }

        .tb-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: .85rem;
            font-weight: 700;
            opacity: .85;
            letter-spacing: .02em
        }

        #tb-wifi {
            font-size: 1.1rem
        }

        #alert-dot {
            display: none;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--orange);
            box-shadow: 0 0 6px var(--orange);
            animation: pulse 1.2s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .3
            }
        }

        /* EYE LAYER */
        #eye-layer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(60px, 12vw, 140px);
            z-index: 1;
            cursor: pointer;
            transition: opacity .4s ease, filter .4s;
        }

        /* EYE LAYER - Massive & Organic */
        #eye-layer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            /* Tighter gap for massive eyes */
            z-index: 1;
            cursor: pointer;
            transition: opacity .4s ease, filter .4s;
        }

        .eye {
            width: clamp(280px, 48vw, 460px);
            height: clamp(280px, 48vw, 460px);
            /* Organic elliptical shape */
            border-radius: 44% 44% 50% 50%;
            position: relative;
            overflow: hidden;
            /* Limbus Ring + Iris Gradient */
            background:
                radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                /* iris shine layer */
                radial-gradient(circle at 50% 50%, #2aaad4 0%, #1a88aa 40%, #0a6680 85%, #053340 100%);
            /* Depth Iris */

            /* Soft, deep shadow for a lens look (less "popped up") */
            box-shadow:
                0 0 70px rgba(77, 210, 255, .25),
                inset 0 0 40px rgba(0, 0, 0, 0.6),
                inset 0 -10px 20px rgba(0, 0, 0, 0.4);

            /* Calibrated transform for a more natural gaze */
            transform: scaleY(.84) translateY(4%);
            transition: transform .5s cubic-bezier(.25, 1, .5, 1), box-shadow .5s, filter .4s;
            border: 2px solid rgba(0, 0, 0, 0.4);
            /* Subtle lid definition */
        }

        .pupil {
            position: absolute;
            width: 44%;
            /* Larger, more expressive pupil */
            height: 44%;
            background: radial-gradient(circle at 40% 40%, #1a1a1a 0%, #000 70%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform .18s cubic-bezier(.25, 1, .5, 1);
            filter: blur(0.5px);
            /* Softer human-like edge */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .hl {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, .8);
            filter: blur(0.5px);
            pointer-events: none;
        }

        .hl.big {
            width: 20%;
            height: 20%;
            top: 15%;
            left: 55%;
            opacity: 0.9;
        }

        .hl.sm {
            width: 10%;
            height: 10%;
            top: 42%;
            left: 25%;
            opacity: .4
        }

        /* SCREENS (full-screen overlays) */
        .screen {
            position: fixed;
            inset: 0;
            z-index: 20;
            display: none;
            flex-direction: column;
            background: var(--bg);
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s ease;
        }

        .screen.visible {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .screen.anim-in {
            animation: screenIn .3s ease forwards
        }

        .screen.anim-out {
            animation: screenOut .25s ease forwards
        }

        @keyframes screenIn {
            from {
                opacity: 0;
                transform: translateX(30px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        @keyframes screenOut {
            from {
                opacity: 1;
                transform: none
            }

            to {
                opacity: 0;
                transform: translateX(-20px)
            }
        }

        /* MAIN MENU ‚Äì card list */
        #screen-menu {
            z-index: 50;
            background: rgba(7, 7, 16, .98);
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .menu-title-bar {
            padding: 48px 28px 20px;
            font-size: .7rem;
            font-weight: 700;
            letter-spacing: .12em;
            text-transform: uppercase;
            opacity: .35;
        }

        .menu-cards {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 18px;
            overflow-y: auto;
        }

        .big-btn {
            display: flex;
            align-items: center;
            gap: 22px;
            padding: 24px 26px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .07);
            border-radius: 24px;
            cursor: pointer;
            transition: background .18s, border-color .18s;
            -webkit-tap-highlight-color: transparent;
            flex-shrink: 0;
        }

        .big-btn:active {
            background: rgba(255, 255, 255, .10);
            border-color: rgba(255, 255, 255, .14);
        }

        .big-btn-icon {
            width: 72px;
            height: 72px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            flex-shrink: 0;
        }

        .icon-actions {
            background: linear-gradient(135deg, rgba(79, 195, 247, .35), rgba(0, 229, 255, .18));
            box-shadow: 0 4px 18px rgba(79, 195, 247, .22)
        }

        .icon-explore {
            background: linear-gradient(135deg, rgba(76, 175, 80, .32), rgba(0, 200, 100, .16));
            box-shadow: 0 4px 18px rgba(76, 175, 80, .22)
        }

        .icon-settings {
            background: linear-gradient(135deg, rgba(255, 255, 255, .14), rgba(150, 150, 180, .1));
            box-shadow: 0 4px 18px rgba(150, 150, 200, .12)
        }

        .big-btn-text {
            flex: 1;
            min-width: 0;
        }

        .big-btn-text h2 {
            font-size: 1.45rem;
            font-weight: 800;
            letter-spacing: -.02em;
        }

        .big-btn-text p {
            font-size: .95rem;
            font-weight: 400;
            opacity: .4;
            margin-top: 4px;
        }

        .big-btn-arrow {
            font-size: 1.1rem;
            opacity: .25;
            flex-shrink: 0;
        }

        /* Close / back-to-idle row at bottom of menu */
        .menu-close-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 28px;
            border: none;
            border-top: 1px solid rgba(255, 255, 255, .07);
            background: transparent;
            color: rgba(255, 255, 255, .38);
            font-size: 1.05rem;
            font-weight: 600;
            letter-spacing: .04em;
            cursor: pointer;
            transition: color .2s;
            margin-top: 8px;
            flex-shrink: 0;
        }

        .menu-close-btn:active {
            color: rgba(255, 255, 255, .7);
        }

        /* Sub-screens */
        .sub-header {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 48px 24px 20px;
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            width: 52px;
            height: 52px;
            border: none;
            background: var(--glass);
            border-radius: 16px;
            color: #fff;
            font-size: 1.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background .2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, .15)
        }

        .sub-header h2 {
            font-size: 1.5rem;
            font-weight: 800
        }

        /* Actions sub-screen ‚Äì same full-screen tiles */
        .action-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background .18s;
            -webkit-tap-highlight-color: transparent;
            min-height: 0;
        }

        .action-item:last-child {
            border-bottom: none
        }

        .action-item:active {
            background: rgba(255, 255, 255, .07)
        }

        .ai-icon {
            width: 100px;
            height: 100px;
            border-radius: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            flex-shrink: 0
        }

        .action-item-text h3 {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: -.03em;
            text-align: center
        }

        .action-item-text p {
            font-size: 1rem;
            opacity: .4;
            margin-top: 6px;
            text-align: center
        }

        /* Explore sub-screen */
        #explore-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 32px
        }

        .explore-toggle-wrap {
            width: 100%;
            background: rgba(255, 255, 255, .05);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: background .2s;
            -webkit-tap-highlight-color: transparent;
        }

        .explore-toggle-wrap.active {
            background: rgba(76, 175, 80, .12);
            border-color: rgba(76, 175, 80, .4)
        }

        .explore-toggle-icon {
            font-size: 2.5rem;
            width: 64px;
            text-align: center
        }

        .explore-toggle-text {
            flex: 1
        }

        .explore-toggle-text h3 {
            font-size: 1.4rem;
            font-weight: 800
        }

        .explore-toggle-text p {
            font-size: .95rem;
            opacity: .45;
            margin-top: 4px
        }

        .tog {
            width: 68px;
            height: 38px;
            background: rgba(60, 60, 80, .8);
            border-radius: 19px;
            position: relative;
            flex-shrink: 0;
            transition: background .3s
        }

        .tog.on {
            background: linear-gradient(90deg, #00c9a7, var(--green))
        }

        .tog::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background: #fff;
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: transform .3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .3)
        }

        .tog.on::after {
            transform: translateX(30px)
        }

        #explore-badge {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 9px 20px;
            background: rgba(7, 7, 16, .85);
            border: 1px solid rgba(79, 195, 247, .35);
            border-radius: 24px;
            font-size: .8rem;
            font-weight: 600;
            color: var(--accent);
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 55;
        }

        .exp-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1.5s infinite
        }

        /* Settings sub-screen */
        #settings-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 24px 20px;
            overflow-y: auto;
            touch-action: pan-y
        }

        .qr-box {
            width: 190px;
            height: 190px;
            background: #fff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px
        }

        #qr-canvas {
            width: 100%;
            height: 100%
        }

        .qr-label {
            text-align: center
        }

        .qr-label h3 {
            font-size: 1rem;
            font-weight: 600
        }

        .qr-label p {
            font-size: .78rem;
            opacity: .45;
            margin-top: 4px;
            line-height: 1.5
        }

        .conn-row {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .cdot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #444;
            flex-shrink: 0
        }

        .cdot.on {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
            animation: pulse 2s infinite
        }

        .conn-info {
            flex: 1
        }

        .conn-info h4 {
            font-size: .9rem;
            font-weight: 600
        }

        .conn-info p {
            font-size: .75rem;
            opacity: .45
        }

        .disc-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 10px;
            background: rgba(244, 67, 54, .15);
            color: var(--red);
            font-size: .8rem;
            font-weight: 600;
            cursor: pointer;
            display: none
        }

        /* Contacts for telepresence - 2x2 Grid (Compact) */
        #contacts-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            overflow: hidden;
            /* Prevent scrolling */
        }

        /* Failsafe Exit Button */
        #failsafe-exit {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            z-index: 9999;
            background: transparent;
            cursor: pointer;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 440px;
            /* Center and constrain */
        }

        .contact-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all .2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            -webkit-tap-highlight-color: transparent;
        }

        .contact-card:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.1);
        }

        .contact-card .avatar {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--accent), #0077aa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            font-weight: 800;
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 150, 255, 0.2);
        }

        .contact-card h3 {
            font-size: 1.25rem;
            font-weight: 800;
            color: #fff;
        }

        .contact-card .status-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .contact-card .status-txt {
            font-size: .85rem;
            font-weight: 700;
            opacity: 0.4;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .contact-card .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
        }

        .contact-card .status-dot.online {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }


        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
            margin-top: 4px
        }

        .status-dot.online {
            background: var(--green);
            box-shadow: 0 0 6px var(--green)
        }

        .call-btn {
            margin-left: auto;
            padding: 9px 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--green), #00c9a7);
            color: #fff;
            font-weight: 700;
            font-size: .85rem;
            cursor: pointer;
            transition: transform .15s;
        }

        .call-btn:active {
            transform: scale(.95)
        }

        .no-contacts {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: .4;
            padding: 40px
        }

        .no-contacts .icon {
            font-size: 2.5rem
        }

        .no-contacts p {
            font-size: .85rem;
            text-align: center
        }

        /* ‚îÄ‚îÄ CALL SCREENS ‚îÄ‚îÄ */
        /* Outgoing call */
        #screen-calling {
            background: radial-gradient(ellipse at 50% 25%, rgba(20, 30, 60, .95), var(--bg));
            text-align: center;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 80;
            padding: 40px 32px
        }

        .call-ring {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(79, 195, 247, .22), rgba(0, 180, 220, .12));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            box-shadow: 0 0 0 1px rgba(79, 195, 247, .2)
        }

        .call-ring::before,
        .call-ring::after,
        .call-ring .ring3 {
            content: '';
            position: absolute;
            border-radius: 50%;
            border: 1.5px solid rgba(79, 195, 247, .25);
            animation: ringPulse 2.4s ease-out infinite;
        }

        .call-ring::before {
            inset: -16px
        }

        .call-ring::after {
            inset: -34px;
            animation-delay: .6s;
            border-color: rgba(79, 195, 247, .14)
        }

        @keyframes ringPulse {
            0% {
                transform: scale(.85);
                opacity: .8
            }

            100% {
                transform: scale(1.2);
                opacity: 0
            }
        }

        .call-name {
            font-size: 2.4rem;
            font-weight: 900;
            letter-spacing: -.03em
        }

        .call-status {
            font-size: .82rem;
            opacity: .45;
            letter-spacing: .04em
        }

        .call-end-round {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #f44336, #c62828);
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform .15s, box-shadow .2s;
            box-shadow: 0 6px 24px rgba(244, 67, 54, .55);
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-end-round:active {
            transform: scale(.88)
        }

        /* Incoming call ‚Äì Google Meet style */
        #screen-incoming {
            background: radial-gradient(ellipse at 50% 20%, rgba(10, 38, 18, 1), #05100a 60%, var(--bg));
            text-align: center;
            justify-content: center;
            align-items: center;
            gap: 0;
            z-index: 80;
            padding: 40px 24px
        }

        .inc-ring {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(76, 175, 80, .3), rgba(0, 220, 130, .2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.4rem;
            position: relative;
            margin-bottom: 32px;
            box-shadow: 0 0 0 1px rgba(76, 175, 80, .25), 0 0 50px rgba(76, 175, 80, .12)
        }

        .inc-ring::before,
        .inc-ring::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            border: 1.5px solid rgba(76, 175, 80, .32);
        }

        .inc-ring::before {
            inset: -18px;
            animation: incRing 1.8s ease-out infinite
        }

        .inc-ring::after {
            inset: -38px;
            animation: incRing 1.8s ease-out .6s infinite;
            border-color: rgba(76, 175, 80, .18)
        }

        @keyframes incRing {
            0% {
                transform: scale(.88);
                opacity: 1
            }

            100% {
                transform: scale(1.22);
                opacity: 0
            }
        }

        .inc-caller {
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: -.03em;
            margin-bottom: 6px
        }

        .inc-sub {
            font-size: .82rem;
            opacity: .45;
            letter-spacing: .04em;
            margin-bottom: 44px
        }

        .inc-btns {
            display: flex;
            gap: 44px;
            align-items: flex-start
        }

        .inc-btn-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px
        }

        .inc-accept,
        .inc-reject {
            width: 78px;
            height: 78px;
            border-radius: 50%;
            border: none;
            font-size: 1.7rem;
            cursor: pointer;
            transition: transform .15s, box-shadow .2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inc-accept {
            background: linear-gradient(135deg, #43a047, #00c853);
            box-shadow: 0 6px 28px rgba(76, 175, 80, .55)
        }

        .inc-reject {
            background: linear-gradient(135deg, #e53935, #c62828);
            box-shadow: 0 6px 28px rgba(244, 67, 54, .55)
        }

        .inc-accept:active,
        .inc-reject:active {
            transform: scale(.88)
        }

        /* Menu close/back to idle button */
        .menu-close-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: none;
            border-top: 1px solid rgba(255, 255, 255, .08);
            background: rgba(7, 7, 16, .97);
            color: rgba(255, 255, 255, .45);
            font-size: .85rem;
            font-weight: 600;
            letter-spacing: .05em;
            cursor: pointer;
            z-index: 2;
            transition: color .2s;
        }

        .menu-close-btn:active {
            color: rgba(255, 255, 255, .8);
        }

        /* Volume slider in Settings */
        .vol-section {
            padding: 28px 24px 20px;
            width: 100%;
        }

        .vol-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .vol-header h3 {
            font-size: 1.4rem;
            font-weight: 800;
        }

        .vol-level {
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent);
            min-width: 80px;
            text-align: right;
        }

        .vol-icons {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 20px;
        }

        .vol-icon {
            font-size: 1.8rem;
            opacity: .65;
            flex-shrink: 0;
        }

        input[type=range].vol-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, .12);
            outline: none;
            cursor: pointer;
        }

        input[type=range].vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 16px rgba(77, 210, 255, .5);
            cursor: pointer;
        }

        input[type=range].vol-slider::-webkit-slider-runnable-track {
            border-radius: 4px;
        }

        .inc-label {
            font-size: .72rem;
            font-weight: 600;
            opacity: .6;
            text-align: center;
            letter-spacing: .02em
        }

        /* Active call */
        #screen-call {
            z-index: 70;
            background: #000
        }

        #remote-video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        #local-video {
            position: absolute;
            bottom: 90px;
            right: 16px;
            width: 110px;
            height: 80px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, .2);
            object-fit: cover;
            z-index: 2;
            background: #111;
        }

        /* Active call name+timer overlay */
        #call-name-bar {
            position: absolute;
            top: 36px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 18px;
            background: rgba(0, 0, 0, .5);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            font-size: .82rem;
            font-weight: 600;
            white-space: nowrap
        }

        #call-name-bar .cdot-live {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite
        }

        #call-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px 24px 32px;
            background: linear-gradient(to top, rgba(0, 0, 0, .92) 0%, rgba(0, 0, 0, .4) 70%, transparent);
        }

        .call-ctl {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, .18);
            backdrop-filter: blur(10px);
            color: #fff;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-ctl:active {
            background: rgba(255, 255, 255, .3)
        }

        .call-ctl.off {
            background: rgba(80, 80, 100, .5);
            opacity: .6
        }

        .call-ctl.end {
            background: linear-gradient(135deg, #f44336, #c62828);
            width: 66px;
            height: 66px;
            font-size: 1.5rem;
            box-shadow: 0 6px 28px rgba(244, 67, 54, .6)
        }

        .call-ctl.end:active {
            transform: scale(.88)
        }

        #call-quality {
            position: absolute;
            top: 40px;
            left: 16px;
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            font-size: .75rem;
            font-weight: 600;
        }

        /* Person alert badge */
        #person-badge {
            display: none;
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 170, 0, .18);
            border: 1px solid var(--orange);
            border-radius: 20px;
            padding: 5px 14px;
            font-size: .75rem;
            font-weight: 600;
            color: var(--orange);
            z-index: 201;
            animation: slideDown .3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px)
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0)
            }
        }

        @keyframes watery-shimmer {

            0%,
            100% {
                filter: brightness(0.85) saturate(1.2);
            }

            50% {
                filter: brightness(1.1) saturate(1.4);
            }
        }

        @keyframes tear-drop {
            0% {
                transform: translateX(-50%) translateY(0) scale(1);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            80% {
                transform: translateX(-50%) translateY(40px) scale(0.8);
                opacity: 1;
            }

            100% {
                transform: translateX(-50%) translateY(50px) scale(0.5);
                opacity: 0;
            }
        }

        @keyframes zzz-float {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                transform: translate(20px, -40px) scale(1.2);
                opacity: 0;
            }
        }

        @keyframes spin {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes heart-beat {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.15);
            }
        }
    </style>
</head>

<body>

    <!-- TOP BAR: only battery + wifi -->
    <div id="top-bar">
        <div class="tb-item"><span id="tb-wifi">üì∂</span></div>
        <div class="tb-item">
            <span id="alert-dot"></span>
            <span id="tb-battery">--<span style="font-size:.6rem;opacity:.55">%</span></span>
        </div>
    </div>

    <div id="person-badge">üëÅ PERSON DETECTED</div>

    <!-- EYE LAYER -->
    <div id="eye-layer" onclick="goScreen('menu')">
        <div class="eye" id="eye-left">
            <div class="pupil" id="pupil-left"></div>
            <div class="hl big"></div>
            <div class="hl sm"></div>
        </div>
        <div class="eye" id="eye-right">
            <div class="pupil" id="pupil-right"></div>
            <div class="hl big"></div>
            <div class="hl sm"></div>
        </div>
    </div>

    <!-- EXPLORE BADGE -->
    <div id="explore-badge" style="display:none">
        <span class="exp-pulse"></span>EXPLORING
    </div>

    <!-- ‚ïê‚ïê MAIN MENU ‚ïê‚ïê -->
    <div class="screen" id="screen-menu">
        <div class="menu-title-bar">Menu</div>
        <div class="menu-cards">
            <div class="big-btn" onclick="enterState('actions')">
                <div class="big-btn-icon icon-actions">ü§ñ</div>
                <div class="big-btn-text">
                    <h2>Actions</h2>
                    <p>AI Mode ¬∑ Telepresence</p>
                </div>
                <span class="big-btn-arrow">‚Ä∫</span>
            </div>
            <div class="big-btn" onclick="enterState('explore')">
                <div class="big-btn-icon icon-explore">üß≠</div>
                <div class="big-btn-text">
                    <h2>Explore</h2>
                    <p>Autonomous ¬∑ Sentry Mode</p>
                </div>
                <span class="big-btn-arrow">‚Ä∫</span>
            </div>
            <div class="big-btn" onclick="enterState('settings')">
                <div class="big-btn-icon icon-settings">‚öôÔ∏è</div>
                <div class="big-btn-text">
                    <h2>Settings</h2>
                    <p>Speaker Volume</p>
                </div>
                <span class="big-btn-arrow">‚Ä∫</span>
            </div>
        </div>
        <button class="menu-close-btn" onclick="enterState('idle')">
            ‚úï&ensp;Close Menu
        </button>
    </div>

    <!-- ‚ïê‚ïê ACTIONS SUB-MENU ‚ïê‚ïê -->
    <div class="screen" id="screen-actions">
        <div class="sub-header">
            <button class="back-btn" onclick="goBack()">‚Äπ</button>
            <h2>Actions</h2>
        </div>
        <div class="action-item" onclick="enterAIMode()">
            <div class="ai-icon"
                style="background:linear-gradient(135deg,rgba(79,195,247,.3),rgba(0,229,255,.18));box-shadow:0 4px 22px rgba(79,195,247,.22)">
                ü§ñ
            </div>
            <div class="action-item-text">
                <h3>AI Mode</h3>
                <p>Chat with KENZA ¬∑ Voice enabled</p>
            </div>
        </div>
        <div class="action-item" onclick="enterState('contacts')">
            <div class="ai-icon"
                style="background:linear-gradient(135deg,rgba(100,200,255,.25),rgba(50,100,255,.18));box-shadow:0 4px 22px rgba(100,180,255,.2)">
                üì°
            </div>
            <div class="action-item-text">
                <h3>Telepresence</h3>
                <p>Video call a remote user</p>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê AI MODE OVERLAY ‚ïê‚ïê -->
    <div class="screen" id="screen-ai" style="z-index:60">
        <div class="sub-header">
            <button class="back-btn" onclick="exitAIMode()">‚Äπ</button>
            <h2 id="ai-status-text">AI Mode ¬∑ Idle</h2>
        </div>
        <div id="chat-msgs"
            style="flex:1;overflow-y:auto;padding:14px 16px 80px;display:flex;flex-direction:column;gap:10px;scrollbar-width:none;touch-action:pan-y">
        </div>
        <button onclick="exitAIMode()"
            style="position:fixed;bottom:0;left:0;right:0;padding:18px;border:none;background:rgba(15,8,8,.97);color:var(--red);font-weight:700;font-size:.95rem;cursor:pointer;border-top:1px solid rgba(244,67,54,.2);z-index:61">‚úï
            Exit AI Mode</button>
    </div>

    <!-- ‚ïê‚ïê CONTACTS (Telepresence) ‚ïê‚ïê -->
    <div class="screen" id="screen-contacts">
        <div class="sub-header">
            <button class="back-btn" onclick="goBack()">‚Äπ</button>
            <h2>Call Someone</h2>
        </div>
        <div id="contacts-body">
            <div class="contact-grid" id="contact-grid">
                <!-- Contacts will be injected here -->
            </div>
            <div class="no-contacts" id="no-contacts" style="display:none">
                <div class="icon">üì°</div>
                <p>No controllers connected.<br>Waiting for remote user‚Ä¶</p>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê EXPLORE ‚ïê‚ïê -->
    <div class="screen" id="screen-explore">
        <div class="sub-header">
            <button class="back-btn" onclick="goBack()">‚Äπ</button>
            <h2>Explore</h2>
        </div>
        <div id="explore-body">
            <div class="explore-toggle-wrap" id="explore-wrap" onclick="toggleExplore()">
                <div class="explore-toggle-icon">üß≠</div>
                <div class="explore-toggle-text">
                    <h3>Autonomous Explore</h3>
                    <p id="explore-desc">Sentry mode activates automatically</p>
                </div>
                <div class="tog" id="explore-tog"></div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê SETTINGS ‚ïê‚ïê -->
    <div class="screen" id="screen-settings">
        <div class="sub-header">
            <button class="back-btn" onclick="goBack()">‚Äπ</button>
            <h2>Settings</h2>
        </div>
        <div id="settings-body">

            <!-- Speaker Volume -->
            <div class="vol-section">
                <div class="vol-header">
                    <h3>üîä Speaker Volume</h3>
                    <span class="vol-level" id="vol-level-txt">80%</span>
                </div>
                <div class="vol-icons">
                    <span class="vol-icon">üîá</span>
                    <input type="range" class="vol-slider" id="vol-slider" min="0" max="100" value="80"
                        oninput="setVolume(this.value)">
                    <span class="vol-icon">üîä</span>
                </div>
            </div>

            <!-- Connection status removed -->


        </div>
    </div>

    <!-- ‚ïê‚ïê OUTGOING CALL ‚ïê‚ïê -->
    <div class="screen" id="screen-calling">
        <div class="call-ring">üìû</div>
        <div class="call-name" id="calling-name">Calling‚Ä¶</div>
        <div class="call-status">RINGING</div>
        <button class="call-end-round" onclick="cancelCall()" title="Cancel">üìµ</button>
    </div>

    <!-- ‚ïê‚ïê INCOMING CALL ‚ïê‚ïê -->
    <div class="screen" id="screen-incoming">
        <div class="inc-ring" id="inc-ring-icon">üìπ</div>
        <div class="inc-caller" id="incoming-name">Incoming Call</div>
        <div class="inc-sub">INCOMING VIDEO CALL</div>
        <div style="font-size:0.78rem;opacity:0.35;letter-spacing:.04em;margin-bottom:28px">TAP ACCEPT TO START</div>
        <div class="inc-btns">
            <div class="inc-btn-wrap">
                <button class="inc-accept" onclick="acceptCall()">‚úì</button>
                <div class="inc-label">Accept</div>
            </div>
            <div class="inc-btn-wrap">
                <button class="inc-reject" onclick="rejectCall()">‚úï</button>
                <div class="inc-label">Decline</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê ACTIVE CALL ‚ïê‚ïê -->
    <div class="screen" id="screen-call">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div id="call-quality">üì∂ <span id="call-quality-txt">Connecting‚Ä¶</span></div>
        <div id="call-name-bar">
            <div class="cdot-live"></div>
            <span id="call-peer-name">Remote</span>
            <span id="call-timer" style="opacity:.5;font-weight:400">0:00</span>
        </div>
        <div id="call-bar">
            <button class="call-ctl" id="btn-cam" onclick="toggleCam()" title="Camera">üì∑</button>
            <button class="call-ctl end" onclick="endCall()" title="End call">üìµ</button>
            <button class="call-ctl" id="btn-mic" onclick="toggleMic()" title="Mic">üéôÔ∏è</button>
        </div>
    </div>

    <script>
        'use strict';

        // ‚ïê‚ïê EYE STATE (Synchronized from Controller) ‚ïê‚ïê
        const eyeState = {
            eyeColor: 'cyan',
            eyeShape: 'round',
            customColor: { h: 190, s: 100, l: 50 },
            brightness: 100,
            followPerson: true,
            saccadeEnabled: true,
            currentAnimation: 'idle'
        };

        const colorPresets = {
            cyan: { h: 190, s: 100, l: 50 },
            orange: { h: 30, s: 100, l: 50 },
            teal: { h: 160, s: 100, l: 50 },
            pink: { h: 330, s: 100, l: 65 },
            purple: { h: 270, s: 100, l: 60 },
            green: { h: 120, s: 100, l: 50 },
            red: { h: 0, s: 100, l: 50 },
            gold: { h: 45, s: 100, l: 50 },
            white: { h: 0, s: 0, l: 95 }
        };

        function applyEyeStyle() {
            const { h, s, l } = eyeState.customColor;
            const brightness = eyeState.brightness / 100;
            const eyes = document.querySelectorAll('.eye');

            eyes.forEach(eye => {
                const adjustedL = l * brightness;
                eye.style.background = `
                    radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                    radial-gradient(circle at 50% 50%, 
                        hsl(${h}, ${s}%, ${Math.min(adjustedL + 30, 100)}%) 0%, 
                        hsl(${h}, ${s}%, ${adjustedL}%) 50%, 
                        hsl(${h}, ${s}%, ${Math.max(adjustedL - 20, 10)}%) 85%,
                        hsl(${h}, ${s}%, ${Math.max(adjustedL - 40, 5)}%) 100%)
                `;
                eye.style.boxShadow = `
                    0 0 ${70 * brightness}px hsla(${h}, ${s}%, ${adjustedL}%, 0.25),
                    inset 0 0 40px rgba(0, 0, 0, 0.6),
                    inset 0 -10px 20px rgba(0, 0, 0, 0.4)
                `;
            });
            applyEyeShape();
        }

        function applyEyeShape() {
            const eyes = document.querySelectorAll('.eye');
            const pupils = document.querySelectorAll('.eye .pupil');

            eyes.forEach(eye => {
                eye.style.width = ''; eye.style.height = '';
                eye.style.borderRadius = '44% 44% 50% 50%';
                eye.style.transform = 'scaleY(.84) translateY(4%)';
                eye.style.filter = '';
            });
            pupils.forEach(p => {
                p.style.width = '44%'; p.style.height = '44%';
                p.style.borderRadius = '50%'; p.style.transform = 'translate(-50%, -50%)';
                p.style.opacity = '1'; p.style.display = 'block';
            });

            switch (eyeState.eyeShape) {
                case 'oval':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(240px, 40vw, 400px)';
                        eye.style.height = 'clamp(320px, 55vw, 540px)';
                        eye.style.borderRadius = '50%';
                    });
                    break;
                case 'anime':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(300px, 50vw, 480px)';
                        eye.style.height = 'clamp(320px, 55vw, 540px)';
                        eye.style.borderRadius = '50% 50% 45% 45%';
                    });
                    pupils.forEach(p => { p.style.width = '48%'; p.style.height = '48%'; });
                    break;
                case 'robot':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(260px, 45vw, 420px)';
                        eye.style.height = 'clamp(260px, 45vw, 420px)';
                        eye.style.borderRadius = '40px';
                    });
                    pupils.forEach(p => {
                        p.style.width = '40%'; p.style.height = '40%';
                        p.style.borderRadius = '15px';
                    });
                    break;
                case 'line':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(320px, 60vw, 500px)';
                        eye.style.height = 'clamp(60px, 12vw, 100px)';
                        eye.style.borderRadius = '40px';
                    });
                    pupils.forEach(p => { p.style.width = '20%'; p.style.height = '50%'; });
                    break;
                case 'rectangle':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(320px, 60vw, 500px)';
                        eye.style.height = 'clamp(200px, 35vw, 300px)';
                        eye.style.borderRadius = '24px';
                    });
                    break;
                case 'diamond':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(260px, 45vw, 420px)';
                        eye.style.height = 'clamp(260px, 45vw, 420px)';
                        eye.style.borderRadius = '20px';
                        eye.style.transform = 'scaleY(.84) translateY(4%) rotate(45deg)';
                    });
                    pupils.forEach(p => {
                        p.style.width = '35%'; p.style.height = '35%';
                        p.style.transform = 'translate(-50%, -50%) rotate(-45deg)';
                    });
                    break;
                case 'cute':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(280px, 48vw, 460px)';
                        eye.style.height = 'clamp(300px, 52vw, 480px)';
                        eye.style.borderRadius = '50% 50% 48% 48%';
                    });
                    pupils.forEach(p => { p.style.width = '55%'; p.style.height = '55%'; });
                    break;
                case 'alien':
                    eyes.forEach(eye => {
                        eye.style.width = 'clamp(200px, 35vw, 300px)';
                        eye.style.height = 'clamp(380px, 65vw, 600px)';
                        eye.style.borderRadius = '45% 45% 50% 50%';
                    });
                    pupils.forEach(p => {
                        p.style.width = '35%'; p.style.height = '45%';
                        p.style.borderRadius = '45%';
                    });
                    break;
            }
        }

        let currentAnimationInterval = null;
        function resetSync() {
            if (currentAnimationInterval) { clearInterval(currentAnimationInterval); currentAnimationInterval = null; }
            document.querySelectorAll('.eye').forEach(eye => {
                eye.style.transform = 'scaleY(.84) translateY(4%)';
                eye.style.filter = ''; eye.style.animation = '';
                eye.querySelectorAll('.emotion-extra').forEach(el => el.remove());
            });
            document.querySelectorAll('.pupil').forEach(p => {
                p.style.display = 'block'; p.style.opacity = '1';
                p.style.transform = 'translate(-50%, -50%)';
            });
            applyEyeStyle();
        }

        function playSync(anim) {
            const eyes = document.querySelectorAll('.eye');
            const leftEye = document.getElementById('eye-left');
            const rightEye = document.getElementById('eye-right');
            const pupils = document.querySelectorAll('.pupil');

            if (anim !== 'blink') resetSync();

            switch (anim) {
                case 'blink':
                    eyes.forEach(e => {
                        const cur = e.style.transform || 'scaleY(.84) translateY(4%)';
                        const base = cur.replace(/scaleY\([^)]*\)/g, '').trim();
                        e.style.transform = base + ' scaleY(0.05)';
                        e.style.transition = 'transform 0.08s ease-in';
                        setTimeout(() => {
                            e.style.transform = cur;
                            e.style.transition = 'transform 0.08s ease-out';
                            setTimeout(() => { e.style.transition = ''; applyEyeShape(); }, 100);
                        }, 80);
                    });
                    break;
                case 'happy':
                    eyes.forEach(e => {
                        e.style.borderRadius = '50% 50% 20% 20%';
                        e.style.transform = 'scaleY(0.4) translateY(20%)';
                        e.querySelector('.pupil').style.display = 'none';
                        const b = document.createElement('div');
                        b.className = 'emotion-extra';
                        b.style.cssText = `position:absolute;bottom:-30%;left:50%;transform:translateX(-50%);width:40%;height:15%;background:radial-gradient(ellipse,rgba(255,150,150,.6) 0%,transparent 70%);border-radius:50%;`;
                        e.appendChild(b);
                    });
                    break;
                case 'sad':
                    eyes.forEach((e, i) => {
                        e.style.transform = `scaleY(0.75) translateY(5%) rotate(${i === 0 ? '-10deg' : '10deg'})`;
                        const t = document.createElement('div');
                        t.className = 'emotion-extra';
                        t.style.cssText = `position:absolute;bottom:-15%;left:50%;transform:translateX(-50%);width:10%;height:20%;background:linear-gradient(180deg,#4dd2ff 0%,#00aaff 100%);border-radius:50% 50% 50% 50%/30% 30% 70% 70%;animation:tear-drop 2s infinite;`;
                        e.appendChild(t);
                    });
                    pupils.forEach(p => { p.style.transform = 'translate(-50%, -20%)'; p.style.width = '35%'; p.style.height = '35%'; });
                    break;
                case 'angry':
                    eyes.forEach((e, i) => {
                        e.style.transform = `scaleY(0.55) translateY(15%) rotate(${i === 0 ? '15deg' : '-15deg'})`;
                        const b = document.createElement('div');
                        b.className = 'emotion-extra';
                        b.style.cssText = `position:absolute;top:-15%;left:50%;transform:translateX(-50%) rotate(${i === 0 ? '-20deg' : '20deg'});width:110%;height:15%;background:#111;border-radius:10px;`;
                        e.appendChild(b);
                    });
                    break;
                case 'surprised':
                    eyes.forEach(e => e.style.transform = 'scale(1.2) translateY(0)');
                    pupils.forEach(p => { p.style.width = '24%'; p.style.height = '24%'; });
                    break;
                case 'sleepy':
                    eyes.forEach(e => {
                        e.style.transform = 'scaleY(0.18) translateY(100%)';
                        e.querySelector('.pupil').style.display = 'none';
                    });
                    break;
                case 'dizzy':
                    eyes.forEach(e => {
                        e.querySelector('.pupil').style.display = 'none';
                        const s = document.createElement('div');
                        s.className = 'emotion-extra';
                        s.style.cssText = `position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(80px,15vw,150px);animation:spin .8s linear infinite;`;
                        s.innerHTML = 'üåÄ';
                        e.appendChild(s);
                    });
                    break;
                case 'love':
                    eyes.forEach(e => {
                        e.style.background = 'radial-gradient(circle at 35% 35%, #ffb3d9 0%, #ff69b4 40%, #ff1493 100%)';
                        e.querySelector('.pupil').style.display = 'none';
                        const h = document.createElement('div');
                        h.className = 'emotion-extra';
                        h.style.cssText = `position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(100px,20vw,180px);color:#fff;animation:heart-beat 1s infinite;`;
                        h.innerHTML = '‚ô•';
                        e.appendChild(h);
                    });
                    break;
                case 'wink':
                    leftEye.style.transform = 'scaleY(0.15) translateY(120%)';
                    leftEye.querySelector('.pupil').style.display = 'none';
                    rightEye.style.transform = 'scale(1.1) translateY(0)';
                    break;
            }
        }
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE MACHINE  ‚Äì  robot_display.html
        // Only ONE state active at a time. All transitions go through
        // enterState(name, payload).  Console-logged for debugging.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const S = {
            state: 'idle',          // current named state
            callState: 'idle',      // idle | calling | incoming | active
            callerName: '',
            camOn: true,
            micOn: true,
            localStream: null,
            exploreOn: false,
            connectedPeers: {},     // name ‚Üí {role}
        };

        // Where "Back" goes from each state
        const BACK_MAP = {
            menu: 'idle',
            actions: 'menu',
            ai: 'menu',
            contacts: 'actions',
            explore: 'menu',
            settings: 'menu',
            // call states return to idle via their own buttons
        };

        // ‚îÄ‚îÄ‚îÄ Core dispatcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function enterState(name, payload = {}) {
            console.log(`[KENZA] ‚ñ∂ ${S.state} ‚Üí ${name}`, payload);

            // 1. Exit outgoing state cleanly
            _exitState(S.state);

            // 2. Force-hide ALL screens (reset any leftover display:flex)
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('visible');
                s.style.display = 'none';
            });

            // 3. Update state
            S.state = name;

            // 4. Enter new state
            switch (name) {

                case 'idle':
                    startEyes();
                    document.getElementById('explore-badge').style.display =
                        S.exploreOn ? 'flex' : 'none';
                    break;

                case 'menu':
                    hideEyes();
                    _showScreen('menu');
                    break;

                case 'actions':
                    hideEyes();
                    _showScreen('actions');
                    break;

                case 'ai':
                    hideEyes();
                    clearChat();
                    setAIStatus('idle');
                    _showScreen('ai');
                    // Add welcome message so the screen is never blank
                    setTimeout(() => {
                        addMsg('kenza', "Hi! I'm listening. What can I help you with?");
                        setAIStatus('listening');
                    }, 300);
                    sendWS({ type: 'ai_mode_enter' });
                    break;

                case 'contacts':
                    hideEyes();
                    _showScreen('contacts');
                    renderContacts();
                    break;

                case 'calling':
                    hideEyes();
                    document.getElementById('calling-name').textContent =
                        payload.name || S.callerName || 'Calling‚Ä¶';
                    _showScreen('calling');
                    break;

                case 'incoming':
                    hideEyes();
                    document.getElementById('incoming-name').textContent =
                        payload.callerName || S.callerName || 'Incoming Call';
                    _showScreen('incoming');
                    break;

                case 'call':
                    hideEyes();
                    {
                        const lv = document.getElementById('local-video');
                        if (lv && S.localStream) lv.srcObject = S.localStream;
                    }
                    {
                        const pn = document.getElementById('call-peer-name');
                        if (pn) pn.textContent = S.callerName || 'Remote';
                    }
                    // reset quality text
                    {
                        const q = document.getElementById('call-quality-txt');
                        if (q) q.textContent = 'Connecting‚Ä¶';
                    }
                    _showScreen('call');
                    startCallTimer();
                    break;

                case 'explore':
                    hideEyes();
                    _showScreen('explore');
                    // Sync toggle UI with current explore state
                    document.getElementById('explore-tog')
                        .classList.toggle('on', S.exploreOn);
                    document.getElementById('explore-wrap')
                        .classList.toggle('active', S.exploreOn);
                    document.getElementById('explore-desc').textContent =
                        S.exploreOn
                            ? 'Sentry mode ACTIVE ‚Äî scanning for people'
                            : 'Sentry mode activates automatically';
                    break;

                case 'settings':
                    hideEyes();
                    _showScreen('settings');
                    drawQR();
                    break;

                default:
                    console.warn('[KENZA] Unknown state:', name);
                    enterState('idle');
            }
        }

        // Called just before leaving a state ‚Äî clean up side-effects
        function _exitState(name) {
            switch (name) {
                case 'ai':
                    sendWS({ type: 'ai_mode_exit' });
                    break;
                case 'explore':
                    // Leaving explore screen: stop exploration if running
                    if (S.exploreOn) {
                        S.exploreOn = false;
                        document.getElementById('explore-badge').style.display = 'none';
                        sendWS({ type: 'explore', active: false });
                        clearPersonAlert();
                    }
                    break;
            }
        }

        // Show a screen element (force display:flex then animate)
        function _showScreen(id) {
            const el = document.getElementById('screen-' + id);
            if (!el) { console.error('[KENZA] Screen not found:', id); return; }
            el.style.display = 'flex';
            // Trigger reflow for CSS transition to fire
            void el.offsetHeight;
            el.classList.add('visible');
        }

        // Navigate back using the back-map
        function goBack() {
            const target = BACK_MAP[S.state] || 'menu';
            console.log(`[KENZA] ‚Äπ Back: ${S.state} ‚Üí ${target}`);
            enterState(target);
        }

        // Convenience alias
        function goHome() { enterState('idle'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EYE ENGINE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const eyes = [document.getElementById('eye-left'), document.getElementById('eye-right')];
        const pupils = [document.getElementById('pupil-left'), document.getElementById('pupil-right')];
        let pupX = -50, pupY = -50;
        let saccTm = null, blinkTm = null;
        let eyesActive = false;

        function setEmotion(emo) {
            const map = {
                neutral: { sy: .78, sh: '0 0 50px rgba(77,210,255,.35)' },
                happy: { sy: .35, sh: '0 0 65px rgba(77,210,255,.6)' },
                thinking: { sy: .70, sh: '0 0 50px rgba(170,100,255,.5)' },
                listening: { sy: .78, sh: '0 0 50px rgba(100,255,150,.45)' },
                speaking: { sy: .78, sh: '0 0 50px rgba(77,210,255,.4)' },
                excited: { sy: .95, sh: '0 0 70px rgba(77,210,255,.8)' },
                alert: { sy: .52, sh: '0 0 50px rgba(255,170,0,.55)' },
                sleep: { sy: 0, sh: 'none' },
            };
            const e = map[emo] || map.neutral;
            eyes.forEach(eye => {
                eye.style.transform = `scaleY(${e.sy}) translateY(8%)`;
                eye.style.boxShadow = e.sh + (e.sh !== 'none'
                    ? ', inset 0 -12px 30px rgba(0,0,0,.25)' : '');
            });
        }

        function faceTrack(nx, ny) {
            if (!eyesActive) return;
            const tx = -50 + (nx - .5) * 44, ty = -50 + (ny - .5) * 28;
            pupils.forEach(p => {
                p.style.transition = 'transform .22s cubic-bezier(.25,1,.5,1)';
                p.style.transform = `translate(${tx}%,${ty}%)`;
            });
            pupX = tx; pupY = ty;
        }

        function runSaccade() {
            if (!eyesActive) return;
            const r = Math.random();
            let nx = -50, ny = -50,
                dur = 900 + Math.random() * 1800,
                ease = 'transform .15s cubic-bezier(.1,.9,.2,1)';
            if (r > .6) {
                nx = -50 + (Math.random() > .5 ? 18 : -18) + (Math.random() * 4 - 2);
                ny = -50 + (Math.random() * 10 - 5);
            } else if (r > .2) {
                nx = pupX + (Math.random() * 6 - 3);
                ny = pupY + (Math.random() * 5 - 2.5);
                ease = 'transform 1s ease-in-out';
            }
            nx = Math.max(-72, Math.min(-28, nx));
            ny = Math.max(-64, Math.min(-36, ny));
            pupX = nx; pupY = ny;
            pupils.forEach(p => { p.style.transition = ease; p.style.transform = `translate(${nx}%,${ny}%)`; });
            saccTm = setTimeout(runSaccade, dur);
        }

        function doBlink(slow = false) {
            if (!eyesActive) return;
            const c = slow ? .28 : .06, o = slow ? .34 : .12;
            eyes.forEach(eye => {
                eye.style.transition = `transform ${c}s cubic-bezier(.2,.8,.2,1)`;
                eye.style.transform = 'scaleY(0) translateY(8%)';
                setTimeout(() => {
                    eye.style.transition = `transform ${o}s cubic-bezier(.2,.8,.2,1)`;
                    eye.style.transform = 'scaleY(.78) translateY(8%)';
                }, c * 1000);
            });
        }

        function schedBlink() {
            blinkTm = setTimeout(() => {
                if (eyesActive) {
                    const r = Math.random();
                    if (r < .15) doBlink(true);
                    else { doBlink(); if (r > .82) setTimeout(doBlink, 200); }
                }
                schedBlink();
            }, 2200 + Math.random() * 3800);
        }

        function startEyes() {
            eyesActive = true;
            document.getElementById('eye-layer').style.opacity = '1';
            setEmotion('neutral');
            if (saccTm) clearTimeout(saccTm);
            setTimeout(runSaccade, 800);
        }

        function pauseEyes() {
            eyesActive = false;
            document.getElementById('eye-layer').style.opacity = '0.15';
            if (saccTm) { clearTimeout(saccTm); saccTm = null; }
        }

        function hideEyes() {
            eyesActive = false;
            document.getElementById('eye-layer').style.opacity = '0';
            if (saccTm) { clearTimeout(saccTm); saccTm = null; }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AI MODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function enterAIMode() {
            console.log('[KENZA] enterAIMode clicked');
            enterState('ai');
        }

        function exitAIMode() {
            console.log('[KENZA] exitAIMode clicked');
            enterState('menu');
        }

        function addMsg(role, text) {
            const msgs = document.getElementById('chat-msgs');
            const d = document.createElement('div');
            const isUser = (role === 'user');
            const isKenza = (role === 'kenza');
            d.style.cssText = `
                padding:13px 16px;
                border-radius:18px;
                max-width:85%;
                font-size:1rem;
                line-height:1.55;
                animation:fadeUp .28s ease;
                word-break:break-word;
                ${isUser
                    ? 'background:linear-gradient(135deg,#4fc3f7,#0077aa);color:#000;margin-left:auto;border-bottom-right-radius:4px;align-self:flex-end;'
                    : 'background:linear-gradient(135deg,rgba(80,50,120,.85),rgba(50,30,90,.9));border:1px solid rgba(150,100,255,.2);border-bottom-left-radius:4px;align-self:flex-start;'
                }`;
            // Label row
            const label = document.createElement('div');
            label.style.cssText = `font-size:.72rem;font-weight:700;opacity:.6;margin-bottom:4px;letter-spacing:.04em;text-transform:uppercase;`;
            label.textContent = isUser ? 'üéô You' : 'ü§ñ KENZA';
            d.appendChild(label);
            // Text
            const txt = document.createElement('div');
            txt.textContent = text;
            d.appendChild(txt);
            msgs.appendChild(d);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function clearChat() {
            const msgs = document.getElementById('chat-msgs');
            if (msgs) msgs.innerHTML = '';
        }

        function setAIStatus(st) {
            const labels = {
                idle: 'ü§ñ AI Mode',
                listening: 'üëÇ Listening‚Ä¶',
                thinking: 'üí≠ Thinking‚Ä¶',
                speaking: 'üîä Speaking',
                sleeping: 'üí§ Sleeping',
            };
            const el = document.getElementById('ai-status-text');
            if (el) el.textContent = labels[st] || st;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EXPLORE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function toggleExplore() {
            console.log('[KENZA] toggleExplore clicked, was:', S.exploreOn);
            S.exploreOn = !S.exploreOn;

            document.getElementById('explore-tog').classList.toggle('on', S.exploreOn);
            document.getElementById('explore-wrap').classList.toggle('active', S.exploreOn);
            document.getElementById('explore-desc').textContent = S.exploreOn
                ? 'Sentry mode ACTIVE ‚Äî scanning for people'
                : 'Sentry mode activates automatically';
            document.getElementById('explore-badge').style.display =
                S.exploreOn ? 'flex' : 'none';

            sendWS({ type: 'explore', active: S.exploreOn });

            if (!S.exploreOn) {
                clearPersonAlert();
                // Return to idle after short delay so user sees toggle snap off
                setTimeout(() => enterState('idle'), 500);
            }
        }

        function showPersonAlert() {
            document.getElementById('person-badge').style.display = 'block';
            document.getElementById('alert-dot').style.display = 'block';
            setEmotion('alert');
            sendWS({ type: 'sentry_alert', detected: true });
        }

        function clearPersonAlert() {
            const pb = document.getElementById('person-badge');
            const ad = document.getElementById('alert-dot');
            if (pb) pb.style.display = 'none';
            if (ad) ad.style.display = 'none';
            if (eyesActive) setEmotion('neutral');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS / QR
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function drawQR() {
            const canvas = document.getElementById('qr-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const sz = canvas.width, cell = Math.floor(sz / 21);
            ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, sz, sz);
            ctx.fillStyle = '#000';
            const rect = (c, r, w = 1, h = 1) =>
                ctx.fillRect(c * cell, r * cell, w * cell, h * cell);
            const finder = (c, r) => {
                rect(c, r, 7, 7);
                ctx.fillStyle = '#fff'; rect(c + 1, r + 1, 5, 5);
                ctx.fillStyle = '#000'; rect(c + 2, r + 2, 3, 3);
            };
            finder(0, 0); finder(14, 0); finder(0, 14);
            const ip = location.hostname || 'robot.local';
            const seed = (ip + '8765').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            for (let y = 0; y < 21; y++) for (let x = 0; x < 21; x++) {
                if (!((x < 8 && y < 8) || (x > 12 && y < 8) || (x < 8 && y > 12))) {
                    if ((seed * x * 71 + y * 113) % 5 < 2) { ctx.fillStyle = '#000'; rect(x, y); }
                }
            }
        }

        function updateConnStatus(conn, name) {
            const dot = document.getElementById('conn-dot');
            const nm = document.getElementById('conn-name');
            const det = document.getElementById('conn-detail');
            const disc = document.getElementById('disc-btn');
            if (dot) dot.classList.toggle('on', !!conn);
            if (nm) nm.textContent = conn ? (name || 'Controller') : 'No Device Linked';
            if (det) det.textContent = conn ? 'Connected and active' : 'Waiting for controller scan‚Ä¶';
            if (disc) disc.style.display = conn ? 'block' : 'none';
        }

        function disconnectDevice() {
            console.log('[KENZA] disconnectDevice clicked');
            sendWS({ type: 'disconnect' });
            updateConnStatus(false, null);
            enterState('idle');
        }

        function setVolume(level) {
            level = Math.round(level);
            const txt = document.getElementById('vol-level-txt');
            if (txt) txt.textContent = level + '%';
            // Dynamic slider gradient fill
            const slider = document.getElementById('vol-slider');
            if (slider) {
                slider.style.background =
                    `linear-gradient(to right, var(--accent) 0%, var(--accent) ${level}%, rgba(255,255,255,.12) ${level}%, rgba(255,255,255,.12) 100%)`;
            }
            console.log('[KENZA] setVolume:', level);
            sendWS({ type: 'set_volume', level });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONTACTS (Telepresence user selection)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const STATIC_CONTACTS = ["Amruth", "Sabil", "Sidharth", "Tejas"];

        function renderContacts() {
            const grid = document.getElementById('contact-grid');
            if (!grid) return;

            grid.innerHTML = '';

            STATIC_CONTACTS.forEach(name => {
                const isOnline = !!S.connectedPeers[name.toLowerCase()] || !!S.connectedPeers[name];
                const card = document.createElement('div');
                card.className = 'contact-card';
                card.dataset.action = "call";
                card.dataset.name = name;

                card.innerHTML = `
                    <div class="avatar">${name[0].toUpperCase()}</div>
                    <h3>${name}</h3>
                    <div class="status-row">
                        <div class="status-dot ${isOnline ? 'online' : ''}"></div>
                        <span class="status-txt">${isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Single event delegate ‚Äî no inline onclick on dynamic DOM
        document.getElementById('contacts-body').addEventListener('click', e => {
            const btn = e.target.closest('[data-action="call"]');
            if (btn) {
                console.log('[KENZA] Call contact:', btn.dataset.name);
                startCall(btn.dataset.name);
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CALL SYSTEM (simplified ‚Äî video via MediaMTX/WHEP, signaling via WebSocket)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let callTimeout = null;

        async function startCall(name) {
            if (S.callState !== 'idle') {
                console.warn('[KENZA] startCall ignored ‚Äî callState:', S.callState);
                return;
            }
            console.log('[KENZA] startCall:', name);
            S.callState = 'calling';
            S.callerName = name;
            enterState('calling', { name });

            // No getUserMedia or WebRTC needed ‚Äî just send call request via WebSocket
            sendWS({ type: 'call_offer', callerName: 'KENZA Robot', to: 'controller' });

            // Auto-cancel if no answer within 45 s
            callTimeout = setTimeout(() => {
                if (S.callState === 'calling') {
                    console.log('[KENZA] Call timeout ‚Äî cancelling');
                    cancelCall();
                }
            }, 45000);
        }

        // ‚îÄ‚îÄ Ring tone (Web Audio API ‚Äî no external file needed) ‚îÄ‚îÄ
        let _ringCtx = null, _ringNodes = [];
        function startRing() {
            try {
                _ringCtx = new (window.AudioContext || window.webkitAudioContext)();
                let ringCount = 0;
                function ringOnce() {
                    if (!_ringCtx) return;
                    const osc = _ringCtx.createOscillator();
                    const gain = _ringCtx.createGain();
                    osc.connect(gain); gain.connect(_ringCtx.destination);
                    osc.type = 'sine';
                    const t = _ringCtx.currentTime;
                    // Two-tone ring: 480 Hz ‚Üí 620 Hz
                    osc.frequency.setValueAtTime(480, t);
                    osc.frequency.setValueAtTime(620, t + 0.5);
                    gain.gain.setValueAtTime(0.35, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 1.2);
                    osc.start(t); osc.stop(t + 1.2);
                    _ringNodes.push(osc, gain);
                    osc.onended = () => { ringCount++; if (ringCount < 8 && _ringCtx) setTimeout(ringOnce, 400); };
                }
                ringOnce();
            } catch (e) { console.warn('[RING] Audio error:', e); }
        }
        function stopRing() {
            _ringNodes.forEach(n => { try { n.disconnect(); } catch (_) { } });
            _ringNodes = [];
            if (_ringCtx) { try { _ringCtx.close(); } catch (_) { } _ringCtx = null; }
        }

        async function handleIncomingCall(data) {
            if (S.callState !== 'idle') {
                console.warn('[KENZA] Incoming call rejected ‚Äî busy:', S.callState);
                sendWS({ type: 'call_busy', to: 'controller' });
                return;
            }
            console.log('[KENZA] Incoming call from:', data.callerName);
            S.callState = 'incoming';
            S.callerName = data.callerName || 'Remote User';
            window._pendingOffer = data.sdp;
            enterState('incoming', { callerName: S.callerName });
            startRing();
        }

        async function acceptCall() {
            console.log('[KENZA] acceptCall clicked');
            if (S.callState !== 'incoming') return;
            stopRing();
            S.callState = 'active';

            // No getUserMedia needed ‚Äî the Pi's camera/mic are streamed via MediaMTX/WHEP
            // Just tell the controller we accepted
            sendWS({ type: 'call_accepted', callerName: 'KENZA Robot', to: 'controller' });

            enterState('call');
            startCallTimer();
        }

        function rejectCall() {
            console.log('[KENZA] rejectCall clicked');
            stopRing();
            sendWS({ type: 'call_reject', to: 'controller' });
            S.callState = 'idle';
            enterState('idle');
        }

        function cancelCall() {
            console.log('[KENZA] cancelCall clicked');
            if (callTimeout) { clearTimeout(callTimeout); callTimeout = null; }
            sendWS({ type: 'call_reject', to: 'controller' });
            cleanupCall();
        }

        function endCall() {
            console.log('[KENZA] endCall clicked');
            sendWS({ type: 'call_end', to: 'controller' });
            cleanupCall();
        }

        function cleanupCall() {
            console.log('[KENZA] cleanupCall');
            stopRing();
            stopCallTimer();

            // Reset call controls to defaults
            S.callState = 'idle'; S.camOn = true; S.micOn = true;
            const bc = document.getElementById('btn-cam');
            const bm = document.getElementById('btn-mic');
            if (bc) { bc.textContent = 'üì∑'; bc.classList.remove('off'); }
            if (bm) { bm.textContent = 'üéôÔ∏è'; bm.classList.remove('off'); }

            // Always return to idle
            enterState('idle');
        }

        // Call timer
        let callTimerInterval = null, callSeconds = 0;
        function startCallTimer() {
            callSeconds = 0;
            clearInterval(callTimerInterval);
            const t = document.getElementById('call-timer');
            if (t) t.textContent = '0:00';
            callTimerInterval = setInterval(() => {
                callSeconds++;
                const m = Math.floor(callSeconds / 60), s = callSeconds % 60;
                if (t) t.textContent = m + ':' + String(s).padStart(2, '0');
            }, 1000);
        }
        function stopCallTimer() {
            clearInterval(callTimerInterval);
            callTimerInterval = null;
        }

        function toggleCam() {
            console.log('[KENZA] toggleCam clicked');
            S.camOn = !S.camOn;
            if (S.localStream)
                S.localStream.getVideoTracks().forEach(t => t.enabled = S.camOn);
            const b = document.getElementById('btn-cam');
            if (b) { b.classList.toggle('off', !S.camOn); b.textContent = S.camOn ? 'üì∑' : 'üö´'; }
        }

        function toggleMic() {
            console.log('[KENZA] toggleMic clicked');
            S.micOn = !S.micOn;
            if (S.localStream)
                S.localStream.getAudioTracks().forEach(t => t.enabled = S.micOn);
            const b = document.getElementById('btn-mic');
            if (b) { b.classList.toggle('off', !S.micOn); b.textContent = S.micOn ? 'üéôÔ∏è' : 'üîá'; }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WEBSOCKET
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let ws = null, wsReconn = null;

        function connectWS() {
            const host = location.hostname || 'localhost';
            console.log(`[KENZA] WS connecting ‚Üí ws://${host}:8765`);
            try {
                ws = new WebSocket(`ws://${host}:8765`);
                ws.onopen = () => {
                    console.log('[KENZA] WS open');
                    clearTimeout(wsReconn);
                    sendWS({ type: 'register', role: 'robot', name: 'KENZA Robot' });
                    // Update top-bar wifi icon
                    const w = document.getElementById('tb-wifi');
                    if (w) w.textContent = 'üì∂';
                };
                ws.onclose = () => {
                    console.log('[KENZA] WS closed ‚Äî reconnecting‚Ä¶');
                    ws = null;
                    const w = document.getElementById('tb-wifi');
                    if (w) w.textContent = '‚ùå';
                    wsReconn = setTimeout(connectWS, 3000);
                };
                ws.onerror = err => console.warn('[KENZA] WS error', err);
                ws.onmessage = e => { try { handleMsg(JSON.parse(e.data)); } catch (_) { } };
            } catch (err) {
                console.warn('[KENZA] WS failed to init:', err);
            }
        }

        function sendWS(obj) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(obj));
            }
        }

        async function handleMsg(d) {
            console.log('[KENZA] ‚Üê msg:', d.type, d);
            switch (d.type) {

                case 'emotion':
                    if (eyesActive) setEmotion(d.state);
                    if (d.state === 'sleep') hideEyes();
                    else if (S.state === 'idle') startEyes();
                    break;

                case 'update_settings':
                    if (d.data && d.data.eyes) {
                        const eyes = d.data.eyes;
                        if (eyes.shape) eyeState.eyeShape = eyes.shape;
                        if (eyes.color) {
                            const preset = colorPresets[eyes.color] || colorPresets.cyan;
                            eyeState.eyeColor = eyes.color;
                            eyeState.customColor = { ...preset };
                        }
                        if (eyes.follow !== undefined) eyeState.followPerson = eyes.follow;
                        applyEyeStyle();
                    }
                    break;

                case 'eye_animation':
                    if (d.data && d.data.animation) {
                        playSync(d.data.animation);
                    }
                    break;

                case 'face_track':
                    if (eyesActive) faceTrack(d.x, d.y);
                    break;

                case 'person_detected':
                    if (S.exploreOn) d.detected ? showPersonAlert() : clearPersonAlert();
                    break;

                case 'ai_state':
                    if (S.state === 'ai') setAIStatus(d.state);
                    break;

                case 'ai_message':
                    if (S.state === 'ai') addMsg(d.role, d.text);
                    break;

                case 'battery':
                    const b = document.getElementById('tb-battery');
                    if (b) b.innerHTML = d.level + '<span style="font-size:.6rem;opacity:.55">%</span>';
                    break;

                case 'wifi':
                    const icons = ['‚ùå', 'üì∂', 'üì∂', 'üì∂'];
                    const w = document.getElementById('tb-wifi');
                    if (w) w.textContent = icons[Math.min(d.signal, 3)] || 'üì∂';
                    break;

                case 'peer_online':
                    console.log('[KENZA] Peer online:', d.name, d.role);
                    S.connectedPeers[d.name] = { role: d.role };
                    updateConnStatus(true, d.name);
                    // Re-announce ourselves
                    sendWS({ type: 'register', role: 'robot', name: 'KENZA Robot' });
                    // Refresh contacts if that screen is visible
                    if (S.state === 'contacts') renderContacts();
                    break;

                case 'peer_offline':
                    console.log('[KENZA] Peer offline:', d.name);
                    delete S.connectedPeers[d.name];
                    if (!Object.keys(S.connectedPeers).length) updateConnStatus(false, null);
                    if (S.state === 'contacts') renderContacts();
                    break;

                case 'controller_connected':
                    S.connectedPeers[d.name || 'Controller'] = { role: 'controller' };
                    updateConnStatus(true, d.name || 'Controller');
                    break;

                case 'call_offer':
                    await handleIncomingCall(d);
                    break;

                case 'call_accepted':
                    if (S.callState === 'calling') {
                        clearTimeout(callTimeout);
                        S.callState = 'active';
                        enterState('call');
                        startCallTimer();
                    }
                    break;

                case 'call_reject':
                    if (S.callState === 'calling') cleanupCall();
                    break;

                case 'call_end':
                    if (S.callState === 'active') cleanupCall();
                    break;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BOOT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        (function boot() {
            console.log('[KENZA] Booting state machine‚Ä¶');

            // Eye-layer tap ‚Üí open menu (from idle)
            document.getElementById('eye-layer').addEventListener('click', () => {
                if (S.state === 'idle') {
                    console.log('[KENZA] Eye-layer tapped ‚Üí menu');
                    enterState('menu');
                }
            });

            // Start blink scheduler
            schedBlink();

            // Enter idle state (starts eyes)
            enterState('idle');

            // Connect WebSocket
            connectWS();

            // Apply initial eye style
            applyEyeStyle();

            console.log('[KENZA] Boot complete.');
        })();
    </script>

</body>


</html>