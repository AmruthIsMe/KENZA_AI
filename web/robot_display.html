<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KENZA Robot Display</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #070710;
            --accent: #4fc3f7;
            --accent2: #00e5ff;
            --green: #4caf50;
            --orange: #ffaa00;
            --red: #f44336;
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.1);
            --text: rgba(255, 255, 255, 0.9);
            --dim: rgba(255, 255, 255, 0.45);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            color: var(--text);
            touch-action: none;
            user-select: none
        }

        /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 200;
            background: linear-gradient(to bottom, rgba(7, 7, 16, 0.9), transparent);
            pointer-events: none;
        }

        .tb-left,
        .tb-right {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.72rem;
            font-weight: 500
        }

        .tb-icon {
            font-size: 0.9rem;
            opacity: .7
        }

        #alert-icon {
            display: none;
            color: var(--orange);
            animation: alertPulse 1s infinite
        }

        @keyframes alertPulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .4
            }
        }

        #person-badge {
            display: none;
            position: fixed;
            top: 44px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 170, 0, 0.18);
            border: 1px solid var(--orange);
            border-radius: 20px;
            padding: 5px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--orange);
            z-index: 201;
            letter-spacing: .04em;
            animation: slideDown .3s ease
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px)
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0)
            }
        }

        /* ‚îÄ‚îÄ EYE CANVAS LAYER ‚îÄ‚îÄ */
        #eye-layer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(40px, 8vw, 100px);
            z-index: 1;
            transition: opacity .4s ease;
        }

        .eye-wrap {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center
        }

        .eye {
            width: clamp(100px, 16vw, 180px);
            height: clamp(100px, 16vw, 180px);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 30% 30%, #6dd9ff 0%, #2aaad4 45%, #0a6680 100%);
            box-shadow: 0 0 30px rgba(77, 210, 255, .3), inset 0 -8px 24px rgba(0, 0, 0, .25);
            transform: scaleY(.75) translateY(10%);
            transition: transform .5s cubic-bezier(.25, 1, .5, 1), box-shadow .5s, filter .4s;
        }

        .pupil {
            position: absolute;
            width: 38%;
            height: 38%;
            background: radial-gradient(circle at 38% 38%, #2a2a2a, #000);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform .2s cubic-bezier(.25, 1, .5, 1);
        }

        .highlight {
            position: absolute;
            width: 22%;
            height: 22%;
            background: rgba(255, 255, 255, .85);
            border-radius: 50%;
            top: 18%;
            left: 58%
        }

        .highlight-sm {
            position: absolute;
            width: 12%;
            height: 12%;
            background: rgba(255, 255, 255, .5);
            border-radius: 50%;
            top: 42%;
            left: 28%
        }

        /* ‚îÄ‚îÄ MODE OVERLAYS ‚îÄ‚îÄ */
        .overlay {
            position: fixed;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity .35s ease;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all
        }

        /* AI CHAT MODE */
        #overlay-ai {
            background: rgba(7, 7, 16, .97);
            padding: 44px 0 0
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: .8rem;
            font-weight: 500;
            color: var(--dim);
            background: rgba(0, 0, 0, .3);
            margin: 8px 16px;
            border-radius: 10px;
            transition: all .3s
        }

        .chat-status.listening {
            color: var(--accent);
            background: rgba(79, 195, 247, .12)
        }

        .chat-status.thinking {
            color: var(--orange);
            background: rgba(255, 170, 0, .12)
        }

        .chat-status.speaking {
            color: var(--green);
            background: rgba(76, 175, 80, .12)
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            flex-shrink: 0
        }

        .chat-status.listening .status-dot,
        .chat-status.thinking .status-dot,
        .chat-status.speaking .status-dot {
            animation: sDot 1.4s infinite
        }

        @keyframes sDot {

            0%,
            100% {
                opacity: 1;
                transform: scale(1)
            }

            50% {
                opacity: .4;
                transform: scale(.7)
            }
        }

        #chat-msgs {
            flex: 1;
            overflow-y: auto;
            padding: 16px 16px 80px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: none;
        }

        #chat-msgs::-webkit-scrollbar {
            display: none
        }

        .msg {
            padding: 13px 16px;
            border-radius: 18px;
            max-width: 80%;
            font-size: clamp(.85rem, 2.2vw, 1rem);
            line-height: 1.5;
            animation: msgIn .25s ease
        }

        @keyframes msgIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .msg.user {
            background: linear-gradient(135deg, var(--accent), #00a8cc);
            color: #000;
            margin-left: auto;
            border-bottom-right-radius: 5px
        }

        .msg.ai {
            background: rgba(50, 50, 70, .7);
            border-bottom-left-radius: 5px
        }

        .msg.thinking-dot {
            background: rgba(50, 50, 70, .5);
            display: flex;
            gap: 5px;
            align-items: center
        }

        .dot-bounce {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: var(--accent);
            animation: bounce 1.4s infinite
        }

        .dot-bounce:nth-child(2) {
            animation-delay: .16s
        }

        .dot-bounce:nth-child(3) {
            animation-delay: .32s
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(.6);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        .ai-exit-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 18px;
            border: none;
            border-radius: 0;
            background: rgba(20, 12, 12, .97);
            color: var(--red);
            font-weight: 600;
            font-size: .95rem;
            cursor: pointer;
            z-index: 20;
            border-top: 1px solid rgba(244, 67, 54, .2);
            transition: background .2s
        }

        .ai-exit-btn:hover,
        .ai-exit-btn:active {
            background: rgba(40, 12, 12, .98)
        }

        /* TELEPRESENCE */
        #overlay-tp {
            background: #000
        }

        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .tp-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .tp-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start
        }

        .tp-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 14px;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            font-size: .8rem;
        }

        .tp-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
            animation: sDot 2s infinite
        }

        .tp-end-btn {
            pointer-events: all;
            padding: 11px 22px;
            border: none;
            border-radius: 22px;
            background: rgba(244, 67, 54, .85);
            color: #fff;
            font-weight: 700;
            font-size: .9rem;
            cursor: pointer;
            transition: all .2s;
        }

        .tp-end-btn:hover {
            background: var(--red);
            transform: scale(1.04)
        }

        /* EXPLORE */
        #explore-badge {
            display: none;
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(7, 7, 16, .8);
            border: 1px solid rgba(79, 195, 247, .3);
            border-radius: 24px;
            padding: 8px 20px;
            font-size: .8rem;
            font-weight: 600;
            color: var(--accent);
            z-index: 50;
            letter-spacing: .05em;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .explore-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: sDot 1.5s infinite
        }

        /* ‚îÄ‚îÄ MENU SHEET ‚îÄ‚îÄ */
        #menu-bg {
            position: fixed;
            inset: 0;
            z-index: 90;
            background: rgba(0, 0, 0, 0);
            pointer-events: none;
            transition: background .4s;
        }

        #menu-bg.open {
            background: rgba(0, 0, 0, .55);
            pointer-events: all
        }

        #menu-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(12, 12, 22, .97);
            border-radius: 28px 28px 0 0;
            border-top: 1px solid var(--border);
            padding: 0 0 40px;
            transform: translateY(100%);
            transition: transform .42s cubic-bezier(.25, 1, .35, 1);
            max-height: 88vh;
            overflow-y: auto;
        }

        #menu-sheet.open {
            transform: translateY(0)
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, .2);
            margin: 14px auto 20px;
        }

        .sheet-section {
            margin-bottom: 8px
        }

        .sheet-section-title {
            font-size: .7rem;
            font-weight: 600;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: .08em;
            padding: 4px 20px 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: background .2s;
            position: relative;
        }

        .menu-item:hover,
        .menu-item:active {
            background: var(--glass)
        }

        .menu-item-icon {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .icon-ai {
            background: linear-gradient(135deg, rgba(79, 195, 247, .25), rgba(0, 229, 255, .15))
        }

        .icon-tp {
            background: linear-gradient(135deg, rgba(255, 102, 170, .2), rgba(170, 50, 200, .15))
        }

        .icon-explore {
            background: linear-gradient(135deg, rgba(76, 175, 80, .2), rgba(0, 200, 100, .1))
        }

        .icon-qr {
            background: linear-gradient(135deg, rgba(255, 255, 255, .1), rgba(200, 200, 200, .05))
        }

        .menu-item-text h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px
        }

        .menu-item-text p {
            font-size: .75rem;
            color: var(--dim)
        }

        .menu-chevron {
            margin-left: auto;
            color: var(--dim);
            font-size: 1.1rem
        }

        .menu-toggle {
            width: 50px;
            height: 28px;
            background: rgba(60, 60, 80, .8);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background .3s;
            margin-left: auto;
            flex-shrink: 0;
        }

        .menu-toggle.on {
            background: linear-gradient(90deg, #00c9ff, var(--accent))
        }

        .menu-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform .3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .3);
        }

        .menu-toggle.on::after {
            transform: translateX(22px)
        }

        .sheet-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 20px
        }

        /* SETTINGS PANEL */
        #settings-panel {
            position: fixed;
            inset: 0;
            z-index: 110;
            background: rgba(10, 10, 18, .98);
            transform: translateX(100%);
            transition: transform .38s cubic-bezier(.25, 1, .35, 1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #settings-panel.open {
            transform: translateX(0)
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px 20px 12px;
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--glass);
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, .15)
        }

        .panel-header h2 {
            font-size: 1.1rem;
            font-weight: 700
        }

        .qr-wrap {
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px
        }

        .qr-box {
            width: 200px;
            height: 200px;
            background: #fff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }

        #qr-canvas {
            width: 100%;
            height: 100%
        }

        .qr-info {
            text-align: center
        }

        .qr-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 6px
        }

        .qr-info p {
            font-size: .8rem;
            color: var(--dim);
            line-height: 1.5
        }

        .conn-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
        }

        .conn-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666
        }

        .conn-dot.connected {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
            animation: sDot 2s infinite
        }

        .conn-info {
            flex: 1
        }

        .conn-info h4 {
            font-size: .9rem;
            font-weight: 600
        }

        .conn-info p {
            font-size: .75rem;
            color: var(--dim)
        }

        .disconnect-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 10px;
            background: rgba(244, 67, 54, .15);
            color: var(--red);
            font-size: .8rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* ‚îÄ‚îÄ ANIMATIONS AND KEYFRAMES ‚îÄ‚îÄ */
        @keyframes sleepBreathe {
            0% {
                box-shadow: 0 0 8px rgba(0, 150, 255, .1), inset 0 -5px 10px rgba(0, 0, 0, .5)
            }

            100% {
                box-shadow: 0 0 25px rgba(0, 150, 255, .25), inset 0 -5px 18px rgba(0, 0, 0, .2)
            }
        }
    </style>
</head>

<body>

    <!-- TOP BAR -->
    <div id="top-bar">
        <div class="tb-left">
            <span id="tb-wifi" class="tb-icon">üì∂</span>
            <span id="tb-mic" class="tb-icon" style="color:var(--accent)">üé§</span>
        </div>
        <div class="tb-right">
            <span id="alert-icon">‚ö†Ô∏è</span>
            <span id="tb-battery" style="font-size:.72rem;font-weight:600">--<span
                    style="font-size:.6rem;opacity:.6">%</span></span>
        </div>
    </div>
    <div id="person-badge">üëÅ PERSON DETECTED</div>

    <!-- EYE LAYER (tap to open menu) -->
    <div id="eye-layer" onclick="openMenu()">
        <div class="eye-wrap">
            <div class="eye" id="eye-left">
                <div class="pupil" id="pupil-left"></div>
                <div class="highlight"></div>
                <div class="highlight-sm"></div>
            </div>
        </div>
        <div class="eye-wrap">
            <div class="eye" id="eye-right">
                <div class="pupil" id="pupil-right"></div>
                <div class="highlight"></div>
                <div class="highlight-sm"></div>
            </div>
        </div>
    </div>

    <!-- EXPLORE BADGE (fixed, shows during explore) -->
    <div id="explore-badge" style="display:none">
        <span class="explore-pulse"></span>EXPLORING
    </div>

    <!-- AI CHAT OVERLAY -->
    <div class="overlay" id="overlay-ai">
        <div class="chat-status" id="chat-status">
            <div class="status-dot"></div>
            <span id="chat-status-text">AI Mode ¬∑ Idle</span>
        </div>
        <div id="chat-msgs"></div>
        <button class="ai-exit-btn" onclick="exitMode('ai')">‚úï Exit AI Mode</button>
    </div>

    <!-- TELEPRESENCE OVERLAY -->
    <div class="overlay" id="overlay-tp">
        <video id="remote-video" autoplay muted playsinline></video>
        <div class="tp-overlay">
            <div class="tp-top">
                <div class="tp-badge">
                    <div class="tp-dot"></div> Live
                </div>
                <div style="display:flex;gap:10px">
                    <div class="tp-badge">üì∂</div>
                    <div class="tp-badge" id="tp-mic-badge">üé§</div>
                </div>
            </div>
            <div style="display:flex;justify-content:center">
                <button class="tp-end-btn" onclick="exitMode('tp')">End Session</button>
            </div>
        </div>
    </div>

    <!-- MENU BACKGROUND -->
    <div id="menu-bg" onclick="closeMenu()"></div>

    <!-- MENU SHEET -->
    <div id="menu-sheet">
        <div class="sheet-handle"></div>

        <!-- ACTIONS -->
        <div class="sheet-section">
            <div class="sheet-section-title">Actions</div>
            <div class="menu-item" onclick="enterMode('ai')">
                <div class="menu-item-icon icon-ai">ü§ñ</div>
                <div class="menu-item-text">
                    <h3>AI Mode</h3>
                    <p>Conversational AI chatbot</p>
                </div>
                <span class="menu-chevron">‚Ä∫</span>
            </div>
            <div class="menu-item" onclick="enterMode('tp')">
                <div class="menu-item-icon icon-tp">üì°</div>
                <div class="menu-item-text">
                    <h3>Telepresence</h3>
                    <p>Full-screen live video</p>
                </div>
                <span class="menu-chevron">‚Ä∫</span>
            </div>
        </div>

        <div class="sheet-divider"></div>

        <!-- EXPLORE -->
        <div class="sheet-section">
            <div class="sheet-section-title">Explore</div>
            <div class="menu-item">
                <div class="menu-item-icon icon-explore">üß≠</div>
                <div class="menu-item-text">
                    <h3>Autonomous Explore</h3>
                    <p>Sentry mode activates automatically</p>
                </div>
                <div class="menu-toggle" id="explore-toggle" onclick="toggleExplore(event)"></div>
            </div>
        </div>

        <div class="sheet-divider"></div>

        <!-- SETTINGS -->
        <div class="sheet-section">
            <div class="sheet-section-title">Settings</div>
            <div class="menu-item" onclick="openSettings()">
                <div class="menu-item-icon icon-qr">üì≤</div>
                <div class="menu-item-text">
                    <h3>Connection</h3>
                    <p>QR pairing &amp; device management</p>
                </div>
                <span class="menu-chevron">‚Ä∫</span>
            </div>
        </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div id="settings-panel">
        <div class="panel-header">
            <button class="back-btn" onclick="closeSettings()">‚Äπ</button>
            <h2>Connection</h2>
        </div>
        <div class="qr-wrap">
            <div class="qr-box">
                <canvas id="qr-canvas" width="176" height="176"></canvas>
            </div>
            <div class="qr-info">
                <h3>Scan to Connect</h3>
                <p>Open the KENZA app and scan this code<br>to link your controller to this robot.</p>
            </div>
            <div class="conn-status" id="conn-status">
                <div class="conn-dot" id="conn-dot"></div>
                <div class="conn-info">
                    <h4 id="conn-name">No Device Linked</h4>
                    <p id="conn-detail">Waiting for controller scan‚Ä¶</p>
                </div>
                <button class="disconnect-btn" id="disconnect-btn" onclick="disconnectDevice()"
                    style="display:none">Disconnect</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // STATE
        // ============================================================
        const S = {
            mode: 'idle',       // idle | ai | tp | explore | sleep
            exploreOn: false,
            sentryAlert: false,
            battery: null,
            connected: false,
            linkedDevice: null,
            eyesActive: true,
        };

        // ============================================================
        // EYE ENGINE
        // ============================================================
        const eyes = [document.getElementById('eye-left'), document.getElementById('eye-right')];
        const pupils = [document.getElementById('pupil-left'), document.getElementById('pupil-right')];

        // Values as % relative to center (translate)
        let pupX = -50, pupY = -50;
        let targetX = -50, targetY = -50;
        let saccadeTimer = null;
        let blinkTimer = null;

        function setEyeEmotion(emo) {
            if (!S.eyesActive) return;
            const map = {
                neutral: { scaleY: .75, filter: 'none', shadow: '0 0 28px rgba(77,210,255,.28)' },
                happy: { scaleY: .35, filter: 'brightness(1.15)', shadow: '0 0 40px rgba(77,210,255,.5)' },
                sad: { scaleY: .6, filter: 'brightness(.8) saturate(1.2)', shadow: '0 0 20px rgba(100,180,255,.3)' },
                thinking: { scaleY: .7, filter: 'none', shadow: '0 0 35px rgba(170,100,255,.5)' },
                listening: { scaleY: .75, filter: 'none', shadow: '0 0 35px rgba(100,255,150,.45)' },
                speaking: { scaleY: .75, filter: 'brightness(1.05)', shadow: '0 0 28px rgba(77,210,255,.32)' },
                excited: { scaleY: .85, filter: 'brightness(1.2)', shadow: '0 0 50px rgba(77,210,255,.7)' },
                confused: { scaleY: .65, filter: 'hue-rotate(20deg)', shadow: '0 0 25px rgba(255,170,0,.4)' },
                alert: { scaleY: .55, filter: 'brightness(1.1)', shadow: '0 0 30px rgba(255,170,0,.5)' },
                sleep: { scaleY: 0, filter: 'brightness(.3)', shadow: 'none' },
            };
            const e = map[emo] || map.neutral;
            eyes.forEach(eye => {
                eye.style.transform = `scaleY(${e.scaleY}) translateY(10%)`;
                eye.style.filter = e.filter;
                eye.style.boxShadow = e.shadow === 'none' ? e.shadow
                    : e.shadow + ', inset 0 -8px 24px rgba(0,0,0,.25)';
            });
        }

        function setPupils(x, y) {
            // x,y are %, e.g. -50 = centered, range roughly -70 to -30
            pupils.forEach(p => {
                p.style.transition = 'transform .18s cubic-bezier(.25,1,.5,1)';
                p.style.transform = `translate(${x}%, ${y}%)`;
            });
        }

        // Organic saccade loop
        function runSaccade() {
            if (!S.eyesActive || S.mode === 'sleep') return;
            const r = Math.random();
            let nx = -50, ny = -50, dur = 900 + Math.random() * 1800, ease = 'transform .15s cubic-bezier(.1,.9,.2,1)';
            if (r < .12) { /* stare pause */ }
            else if (r < .22) { nx = -50 + (Math.random() * 14 - 7); ny = -50 + (Math.random() * 8 - 4); ease = 'transform 1.1s ease-in-out'; dur = 1400; }
            else if (r < .6) { nx = -50 + (Math.random() > .5 ? 18 : -18) + (Math.random() * 4 - 2); ny = -50 + (Math.random() * 10 - 5); }
            else { nx = pupX + (Math.random() * 6 - 3); ny = pupY + (Math.random() * 5 - 2.5); }
            nx = Math.max(-72, Math.min(-28, nx));
            ny = Math.max(-64, Math.min(-36, ny));
            pupX = nx; pupY = ny;
            pupils.forEach(p => { p.style.transition = ease; p.style.transform = `translate(${nx}%,${ny}%)`; });
            saccadeTimer = setTimeout(runSaccade, dur);
        }

        // Face tracking: call this with normalized x,y ‚àà [0,1]
        function faceTrack(nx, ny) {
            const tx = -50 + (nx - .5) * 44;  // map center=‚Äì50, edges = ¬±22
            const ty = -50 + (ny - .5) * 28;
            pupils.forEach(p => {
                p.style.transition = 'transform .22s cubic-bezier(.25,1,.5,1)';
                p.style.transform = `translate(${tx}%,${ty}%)`;
            });
            pupX = tx; pupY = ty;
        }

        // Blink system
        function doBlink(slow = false) {
            const dur = slow ? .28 : (.05 + Math.random() * .05);
            const open = slow ? .32 : .1;
            eyes.forEach(eye => {
                const base = eye.style.transform.replace(/\s*scaleY\([^)]*\)/, '').replace(/\s*translate[^)]*\)/, '').trim();
                eye.style.transition = `transform ${dur}s cubic-bezier(.2,.8,.2,1)`;
                eye.style.transform = base + ' scaleY(0) translateY(10%)';
                setTimeout(() => {
                    eye.style.transition = `transform ${open}s cubic-bezier(.2,.8,.2,1)`;
                    eye.style.transform = base + ' scaleY(.75) translateY(10%)';
                    setTimeout(() => { eye.style.transition = ''; setEyeEmotion('neutral'); }, open * 1000 + 20);
                }, dur * 1000);
            });
        }

        function schedBlink() {
            const d = 2200 + Math.random() * 4000;
            blinkTimer = setTimeout(() => {
                if (S.eyesActive && S.mode !== 'sleep') {
                    const r = Math.random();
                    if (r < .15) doBlink(true);
                    else { doBlink(false); if (r > .82) setTimeout(() => doBlink(false), 200); }
                }
                schedBlink();
            }, d);
        }

        function startEyes() {
            S.eyesActive = true;
            document.getElementById('eye-layer').style.opacity = '1';
            setEyeEmotion('neutral');
            if (saccadeTimer) clearTimeout(saccadeTimer);
            setTimeout(runSaccade, 800);
        }

        function stopEyes() {
            S.eyesActive = false;
            document.getElementById('eye-layer').style.opacity = '0';
            if (saccadeTimer) { clearTimeout(saccadeTimer); saccadeTimer = null; }
        }

        // ============================================================
        // MODE SWITCHING
        // ============================================================
        function enterMode(mode) {
            closeMenu();
            S.mode = mode;
            document.getElementById('overlay-ai').classList.toggle('active', mode === 'ai');
            document.getElementById('overlay-tp').classList.toggle('active', mode === 'tp');
            if (mode === 'ai' || mode === 'tp') {
                stopEyes();
            } else {
                startEyes();
            }
            // Telepresence: start camera
            if (mode === 'tp') startTelep();
        }

        function exitMode(mode) {
            document.getElementById(`overlay-${mode}`).classList.remove('active');
            if (mode === 'tp') stopTelep();
            S.mode = S.exploreOn ? 'explore' : 'idle';
            startEyes();
        }

        // ============================================================
        // TELEPRESENCE
        // ============================================================
        let tpStream = null;
        function startTelep() {
            const v = document.getElementById('remote-video');
            if (navigator.mediaDevices?.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                    tpStream = s; v.srcObject = s;
                }).catch(() => {
                    v.style.background = 'linear-gradient(135deg,#12121a,#0a1520)';
                });
            }
        }
        function stopTelep() {
            if (tpStream) { tpStream.getTracks().forEach(t => t.stop()); tpStream = null; }
            document.getElementById('remote-video').srcObject = null;
        }

        // ============================================================
        // EXPLORE / SENTRY
        // ============================================================
        function toggleExplore(e) {
            e.stopPropagation();
            S.exploreOn = !S.exploreOn;
            const tog = document.getElementById('explore-toggle');
            tog.classList.toggle('on', S.exploreOn);
            const badge = document.getElementById('explore-badge');
            if (S.exploreOn) {
                badge.style.display = 'flex';
                if (S.mode === 'idle') { S.mode = 'explore'; startEyes(); }
                sendWS({ type: 'explore', active: true });
            } else {
                badge.style.display = 'none';
                clearPersonAlert();
                S.mode = 'idle';
                sendWS({ type: 'explore', active: false });
            }
        }

        function showPersonAlert() {
            S.sentryAlert = true;
            document.getElementById('person-badge').style.display = 'block';
            document.getElementById('alert-icon').style.display = 'inline';
            setEyeEmotion('alert');
            sendWS({ type: 'sentry_alert', detected: true });
        }

        function clearPersonAlert() {
            S.sentryAlert = false;
            document.getElementById('person-badge').style.display = 'none';
            document.getElementById('alert-icon').style.display = 'none';
            if (S.eyesActive) setEyeEmotion('neutral');
        }

        // ============================================================
        // MENU
        // ============================================================
        function openMenu() {
            if (S.mode === 'ai' || S.mode === 'tp') return;
            document.getElementById('menu-bg').classList.add('open');
            document.getElementById('menu-sheet').classList.add('open');
        }
        function closeMenu() {
            document.getElementById('menu-bg').classList.remove('open');
            document.getElementById('menu-sheet').classList.remove('open');
        }

        // ============================================================
        // SETTINGS / QR
        // ============================================================
        function openSettings() {
            closeMenu();
            document.getElementById('settings-panel').classList.add('open');
            drawQR();
        }
        function closeSettings() {
            document.getElementById('settings-panel').classList.remove('open');
        }
        function disconnectDevice() {
            S.connected = false; S.linkedDevice = null;
            updateConnStatus(false, null);
            sendWS({ type: 'disconnect' });
        }
        function updateConnStatus(connected, name) {
            document.getElementById('conn-dot').classList.toggle('connected', connected);
            document.getElementById('conn-name').textContent = connected ? (name || 'Controller') : 'No Device Linked';
            document.getElementById('conn-detail').textContent = connected ? 'Connected and active' : 'Waiting for controller scan‚Ä¶';
            document.getElementById('disconnect-btn').style.display = connected ? 'block' : 'none';
        }

        // Simple QR painter (draws a placeholder matrix; replace with qrcode.js if desired)
        function drawQR() {
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            const modules = 21; // version 1
            const cell = Math.floor(size / modules);
            // Generate placeholder QR pattern representation
            const ip = location.hostname || '192.168.x.x';
            const data = `http://${ip}:8765`;
            // Simple visual QR placeholder (3 finder patterns + random modules)
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#000';
            function rect(col, row, w = 1, h = 1) { ctx.fillRect(col * cell, row * cell, w * cell, h * cell); }
            function finder(c, r) {
                rect(c, r, 7, 7); ctx.fillStyle = '#fff'; rect(c + 1, r + 1, 5, 5);
                ctx.fillStyle = '#000'; rect(c + 2, r + 2, 3, 3);
            }
            finder(0, 0); finder(14, 0); finder(0, 14);
            // Random data modules (decorative)
            const seed = data.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            for (let y = 0; y < modules; y++) for (let x = 0; x < modules; x++) {
                const inFinder = (x < 8 && y < 8) || (x > 12 && y < 8) || (x < 8 && y > 12);
                if (!inFinder && ((seed * x * 71 + y * 113) % 5 < 2)) { ctx.fillStyle = '#000'; rect(x, y); }
            }
        }

        // ============================================================
        // CHAT MESSAGES
        // ============================================================
        function addMsg(role, text) {
            const msgs = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.textContent = text;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function setAiStatus(st) {
            const bar = document.getElementById('chat-status');
            const labels = { idle: 'AI Mode ¬∑ Idle', listening: 'Listening‚Ä¶', thinking: 'Thinking‚Ä¶', speaking: 'Speaking' };
            bar.className = 'chat-status ' + st;
            document.getElementById('chat-status-text').textContent = labels[st] || st;
        }

        function showThinkingDots() {
            const msgs = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = 'msg thinking-dot'; div.id = 'thinking-msg';
            for (let i = 0; i < 3; i++) { const d = document.createElement('div'); d.className = 'dot-bounce'; div.appendChild(d); }
            msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
        }
        function removeThinkingDots() {
            const t = document.getElementById('thinking-msg');
            if (t) t.remove();
        }

        // ============================================================
        // TOP BAR UPDATES
        // ============================================================
        function updateBattery(pct) {
            document.getElementById('tb-battery').innerHTML = pct + '<span style="font-size:.6rem;opacity:.6">%</span>';
        }
        function updateWifi(signal) {
            const icons = ['üìµ', 'üì∂', 'üì∂', 'üì∂'];
            document.getElementById('tb-wifi').textContent = icons[Math.min(signal, 3)] || 'üì∂';
        }
        function updateMic(active) {
            document.getElementById('tb-mic').style.color = active ? 'var(--accent)' : 'var(--dim)';
        }

        // ============================================================
        // WEBSOCKET
        // ============================================================
        let ws = null;
        let wsReconnectTimer = null;

        function connectWS() {
            const host = location.hostname || 'localhost';
            const url = `ws://${host}:8765`;
            try {
                ws = new WebSocket(url);
                ws.onopen = () => { console.log('[WS] connected'); clearTimeout(wsReconnectTimer); };
                ws.onclose = () => { ws = null; wsReconnectTimer = setTimeout(connectWS, 3000); };
                ws.onerror = () => { };
                ws.onmessage = (e) => {
                    try { handleMsg(JSON.parse(e.data)); } catch (_) { }
                };
            } catch (_) { }
        }

        function sendWS(obj) {
            if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
        }

        function handleMsg(d) {
            switch (d.type) {
                case 'emotion':
                    if (S.eyesActive) setEyeEmotion(d.state);
                    if (d.state === 'sleep') { S.mode = 'sleep'; stopEyes(); }
                    else if (S.mode === 'sleep' && d.state !== 'sleep') { S.mode = 'idle'; startEyes(); }
                    break;
                case 'face_track':
                    if (S.eyesActive && S.mode !== 'ai' && S.mode !== 'tp') faceTrack(d.x, d.y);
                    break;
                case 'person_detected':
                    if (S.exploreOn) { d.detected ? showPersonAlert() : clearPersonAlert(); }
                    break;
                case 'ai_state':
                    if (S.mode === 'ai') setAiStatus(d.state);
                    if (d.state === 'thinking') showThinkingDots();
                    else removeThinkingDots();
                    break;
                case 'ai_message':
                    if (S.mode === 'ai') { removeThinkingDots(); addMsg(d.role, d.text); }
                    break;
                case 'battery':
                    updateBattery(d.level);
                    break;
                case 'wifi':
                    updateWifi(d.signal);
                    break;
                case 'mic':
                    updateMic(d.active);
                    break;
                case 'controller_connected':
                    S.connected = true; S.linkedDevice = d.name || 'Controller';
                    updateConnStatus(true, S.linkedDevice);
                    break;
                // Legacy gesture cursor (from older server)
                default:
                    if (d.x !== undefined) { /* gesture ignored on robot side */ }
            }
        }

        // ============================================================
        // BOOT
        // ============================================================
        setEyeEmotion('neutral');
        schedBlink();
        setTimeout(runSaccade, 1000);
        connectWS();
    </script>
</body>

</html>